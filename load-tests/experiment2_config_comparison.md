# Experiment 2 测试配置对比

## 第一次测试配置（已完成）

| 组件 | 配置 |
|------|------|
| **测试客户端** | AWS EC2 t3.medium (2 vCPU, 4GB RAM) |
| **实例ID** | i-02f0cd542727905dc |
| **区域** | us-west-2 |
| **端口限制** | ~4,500 (系统默认) |

### 第一次测试结果

| 连接数 | 成功率 | P50 (ms) | P95 (ms) | P99 (ms) | Max (ms) |
|--------|--------|----------|----------|----------|----------|
| 100 | 100% | 13.80 | 19.99 | 20.98 | 21.20 |
| 1,000 | 100% | 75.93 | 93.36 | 105.31 | 108.30 |
| 4,449* | 89% | 390.51 | 916.16 | 971.49 | 987.57 |
| 10,000 | 45% | - | - | - | 失败 |

*请求5,000连接，实际成功4,449个

---

## 第二次测试配置（分布式测试 - 已完成）

| 组件 | 配置 | 变化 |
|------|------|------|
| **测试客户端** | 3x AWS EC2 t3.medium (2 vCPU, 4GB RAM) | 分布式 |
| **实例IDs** | i-02f0cd542727905dc, i-085b8ce61ec6136f1, i-081346ae93c12f53d | 3台 |
| **区域** | us-west-2 | 不变 |
| **每台端口限制** | ~3,500 | 系统默认 |
| **总连接数** | ~10,500 (3 x 3,500) | 分布式叠加 |

### 分布式测试方案

由于 AWS Academy 限制无法创建 c5.xlarge 实例，采用 **3台 t3.medium 分布式测试**：

```
                    ┌─────────────────────┐
                    │  Broadcast Service  │
                    │   (ECS Fargate)     │
                    └──────────┬──────────┘
                               │
              ┌────────────────┼────────────────┐
              │                │                │
     ┌────────▼────────┐ ┌─────▼─────┐ ┌────────▼────────┐
     │ EC2 Instance 1  │ │ Instance 2│ │ EC2 Instance 3  │
     │   3,020 连接    │ │ 3,096 连接│ │   3,375 连接    │
     └─────────────────┘ └───────────┘ └─────────────────┘
                    │
            总计: 9,491 连接
```

### 第二次测试结果

| 实例 | 目标连接 | 实际连接 | P50 (ms) | P95 (ms) | P99 (ms) |
|------|----------|----------|----------|----------|----------|
| Instance 1 | 3,500 | 3,020 | 230.55 | 519.47 | 554.28 |
| Instance 2 | 3,500 | 3,096 | 119.41 | 324.25 | 452.60 |
| Instance 3 | 3,500 | 3,375 | * | * | * |
| **总计** | 10,500 | **9,491** | - | - | - |

*Instance 3 存在时钟同步问题，延迟数据不准确

### 关键发现

1. **成功建立 ~9,500 并发 WebSocket 连接**
2. **所有消息 100% 成功送达**（每个 bid 都被所有连接收到）
3. **广播延迟在可接受范围**（P99 < 600ms for ~3000 connections per instance）

---

## 服务端配置（两次测试相同）

| 组件 | 配置 |
|------|------|
| **Broadcast Service** | ECS Fargate (1 vCPU, 2GB RAM) |
| **API Gateway** | ECS Fargate (1 vCPU, 2GB RAM) |
| **Redis** | ElastiCache cache.t3.micro |
| **Strategy** | Lua Script |
| **ALB (WebSocket)** | BroadcastService-ALB-*.us-west-2.elb.amazonaws.com |
| **ALB (API)** | ApiGateway-ALB-*.us-west-2.elb.amazonaws.com |
